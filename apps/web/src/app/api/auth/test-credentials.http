###
# Authentication API Testing - CertificablePlus
#
# Instructions:
# 1. Install REST Client extension in VS Code
# 2. Open this file and click "Send Request" above each request
# 3. All users use password: "password123"
#
# Base URL: http://localhost:3000/api
###

@baseUrl = http://localhost:3000/api
@contentType = application/json

### Variables (updated after login)
@token = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
@refreshToken = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

###
# 1. POST /auth/register - Register new user
POST {{baseUrl}}/auth/register
Content-Type: {{contentType}}

{
  "email": "test.user@example.com",
  "password": "password123",
  "name": "Test User",
  "role": "employee",
  "companyId": "company-1"
}

###
# 2. POST /auth/login - Login with company user
POST {{baseUrl}}/auth/login
Content-Type: {{contentType}}

{
  "email": "mario.rossi@segnaletica.it",
  "password": "password123"
}

###
# 3. POST /auth/login - Login with employee user
POST {{baseUrl}}/auth/login
Content-Type: {{contentType}}

{
  "email": "giuseppe.verdi@segnaletica.it",
  "password": "password123"
}

###
# 4. POST /auth/login - Login with viewer user
POST {{baseUrl}}/auth/login
Content-Type: {{contentType}}

{
  "email": "luca.observer@demo.com",
  "password": "password123"
}

###
# 5. POST /auth/login - Invalid credentials (should fail)
POST {{baseUrl}}/auth/login
Content-Type: {{contentType}}

{
  "email": "invalid@example.com",
  "password": "wrongpassword"
}

###
# 6. GET /auth/me - Get current user (requires token)
# Update @token variable above with token from login response
GET {{baseUrl}}/auth/me
Authorization: Bearer {{token}}

###
# 7. POST /auth/refresh - Refresh access token
# Update @refreshToken variable with refreshToken from login response
POST {{baseUrl}}/auth/refresh
Content-Type: {{contentType}}

{
  "refreshToken": "{{refreshToken}}"
}

###
# 8. POST /auth/logout - Logout user
POST {{baseUrl}}/auth/logout
Authorization: Bearer {{token}}

###
# 9. GET /auth/me - Should fail after logout
GET {{baseUrl}}/auth/me
Authorization: Bearer {{token}}

###
# Test: Missing Authorization header
GET {{baseUrl}}/auth/me

###
# Test: Invalid token format
GET {{baseUrl}}/auth/me
Authorization: InvalidToken

###
# Test: Register with missing fields (should fail)
POST {{baseUrl}}/auth/register
Content-Type: {{contentType}}

{
  "email": "incomplete@example.com",
  "password": "password123"
}

###
# Test: Register with invalid email (should fail)
POST {{baseUrl}}/auth/register
Content-Type: {{contentType}}

{
  "email": "invalid-email",
  "password": "password123",
  "name": "Test User",
  "role": "employee",
  "companyId": "company-1"
}

###
# Test: Register with existing email (should fail)
POST {{baseUrl}}/auth/register
Content-Type: {{contentType}}

{
  "email": "mario.rossi@segnaletica.it",
  "password": "password123",
  "name": "Duplicate User",
  "role": "company",
  "companyId": "company-1"
}

###
# Test: Short password (should fail)
POST {{baseUrl}}/auth/register
Content-Type: {{contentType}}

{
  "email": "newuser@example.com",
  "password": "123",
  "name": "Test User",
  "role": "employee",
  "companyId": "company-1"
}

###
# Test: Invalid role (should fail)
POST {{baseUrl}}/auth/register
Content-Type: {{contentType}}

{
  "email": "newuser@example.com",
  "password": "password123",
  "name": "Test User",
  "role": "admin",
  "companyId": "company-1"
}

###
# COMPLETE WORKFLOW TEST
# Step 1: Register new user
POST {{baseUrl}}/auth/register
Content-Type: {{contentType}}

{
  "email": "workflow.test@example.com",
  "password": "password123",
  "name": "Workflow Test User",
  "role": "employee",
  "companyId": "company-1"
}

###
# Step 2: Login with new user (copy token from response)
POST {{baseUrl}}/auth/login
Content-Type: {{contentType}}

{
  "email": "workflow.test@example.com",
  "password": "password123"
}

###
# Step 3: Get user profile (paste token below)
GET {{baseUrl}}/auth/me
Authorization: Bearer PASTE_TOKEN_HERE

###
# Step 4: Refresh token (paste refreshToken below)
POST {{baseUrl}}/auth/refresh
Content-Type: {{contentType}}

{
  "refreshToken": "PASTE_REFRESH_TOKEN_HERE"
}

###
# Step 5: Logout
POST {{baseUrl}}/auth/logout
Authorization: Bearer PASTE_TOKEN_HERE

###
# Step 6: Verify logout (should fail)
GET {{baseUrl}}/auth/me
Authorization: Bearer PASTE_TOKEN_HERE